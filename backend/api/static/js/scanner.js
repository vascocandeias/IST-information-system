const room = {
    "building": "Torre Norte",
    "capacity": {
        "exam": 30,
        "normal": 93
    },
    "containedSpaces": [],
    "description": "FA1",
    "events": [
        {
            "day": "21/12/2019",
            "description": "Andr\u00e9 Pires\r\next 1210\r\n",
            "end": "13:00",
            "period": {
                "end": "21/12/2019 13:00",
                "start": "21/12/2019 09:00"
            },
            "start": "09:00",
            "title": "econtro alunos fisica ",
            "type": "GENERIC",
            "weekday": "S\u00e1b"
        },
        {
            "course": {
                "academicTerm": "1\u00ba Semestre 2019/2020",
                "acronym": "PEQB7",
                "id": "1408985496305716",
                "name": "Processos de Engenharia Qu\u00edmica e Biol\u00f3gica",
                "url": "https://fenix.tecnico.ulisboa.pt/disciplinas/PEQB7/2019-2020/1-semestre"
            },
            "day": "16/12/2019",
            "end": "12:30",
            "info": "PB",
            "period": {
                "end": "16/12/2019 12:30",
                "start": "16/12/2019 11:00"
            },
            "start": "11:00",
            "type": "LESSON",
            "weekday": "Seg"
        },
        {
            "course": {
                "academicTerm": "1\u00ba Semestre 2019/2020",
                "acronym": "SSof7",
                "id": "1408985496305696",
                "name": "Seguran\u00e7a em Software",
                "url": "https://fenix.tecnico.ulisboa.pt/disciplinas/SSof7/2019-2020/1-semestre"
            },
            "day": "16/12/2019",
            "end": "11:00",
            "info": "T",
            "period": {
                "end": "16/12/2019 11:00",
                "start": "16/12/2019 09:30"
            },
            "start": "09:30",
            "type": "LESSON",
            "weekday": "Seg"
        },
        {
            "course": {
                "academicTerm": "1\u00ba Semestre 2019/2020",
                "acronym": "MF577",
                "id": "1408985496305577",
                "name": "Mec\u00e2nica dos Fluidos I",
                "url": "https://fenix.tecnico.ulisboa.pt/disciplinas/MF577/2019-2020/1-semestre"
            },
            "day": "18/12/2019",
            "end": "16:00",
            "info": "T",
            "period": {
                "end": "18/12/2019 16:00",
                "start": "18/12/2019 14:30"
            },
            "start": "14:30",
            "type": "LESSON",
            "weekday": "Qua"
        },
        {
            "course": {
                "academicTerm": "1\u00ba Semestre 2019/2020",
                "acronym": "CDI2777",
                "id": "1408985496305565",
                "name": "C\u00e1lculo Diferencial e Integral I",
                "url": "https://fenix.tecnico.ulisboa.pt/disciplinas/CDI2777/2019-2020/1-semestre"
            },
            "day": "20/12/2019",
            "end": "14:00",
            "info": "T",
            "period": {
                "end": "20/12/2019 14:00",
                "start": "20/12/2019 13:00"
            },
            "start": "13:00",
            "type": "LESSON",
            "weekday": "Sex"
        },
        {
            "course": {
                "academicTerm": "1\u00ba Semestre 2019/2020",
                "acronym": "IAC45179577",
                "id": "1408985496305446",
                "name": "Introdu\u00e7\u00e3o \u00e0 Arquitetura de Computadores",
                "url": "https://fenix.tecnico.ulisboa.pt/disciplinas/IAC45179577/2019-2020/1-semestre"
            },
            "day": "18/12/2019",
            "end": "12:30",
            "info": "T",
            "period": {
                "end": "18/12/2019 12:30",
                "start": "18/12/2019 11:00"
            },
            "start": "11:00",
            "type": "LESSON",
            "weekday": "Qua"
        },
        {
            "course": {
                "academicTerm": "1\u00ba Semestre 2019/2020",
                "acronym": "VComp25179577",
                "id": "1408985496305421",
                "name": "Vis\u00e3o Computacional",
                "url": "https://fenix.tecnico.ulisboa.pt/disciplinas/VComp25179577/2019-2020/1-semestre"
            },
            "day": "17/12/2019",
            "end": "11:30",
            "info": "T",
            "period": {
                "end": "17/12/2019 11:30",
                "start": "17/12/2019 09:30"
            },
            "start": "09:30",
            "type": "LESSON",
            "weekday": "Ter"
        },
        {
            "course": {
                "academicTerm": "1\u00ba Semestre 2019/2020",
                "acronym": "CMM25179577",
                "id": "1408985496305391",
                "name": "Comportamento Mec\u00e2nico dos Materiais",
                "url": "https://fenix.tecnico.ulisboa.pt/disciplinas/CMM25179577/2019-2020/1-semestre"
            },
            "day": "20/12/2019",
            "end": "12:30",
            "info": "T",
            "period": {
                "end": "20/12/2019 12:30",
                "start": "20/12/2019 11:00"
            },
            "start": "11:00",
            "type": "LESSON",
            "weekday": "Sex"
        },
        {
            "course": {
                "academicTerm": "1\u00ba Semestre 2019/2020",
                "acronym": "GPro25179577",
                "id": "1408985496305330",
                "name": "Gest\u00e3o da Produ\u00e7\u00e3o",
                "url": "https://fenix.tecnico.ulisboa.pt/disciplinas/GPro25179577/2019-2020/1-semestre"
            },
            "day": "16/12/2019",
            "end": "16:30",
            "info": "T",
            "period": {
                "end": "16/12/2019 16:30",
                "start": "16/12/2019 14:30"
            },
            "start": "14:30",
            "type": "LESSON",
            "weekday": "Seg"
        },
        {
            "course": {
                "academicTerm": "1\u00ba Semestre 2019/2020",
                "acronym": "MC235179577",
                "id": "1408985496305304",
                "name": "Matem\u00e1tica Computacional",
                "url": "https://fenix.tecnico.ulisboa.pt/disciplinas/MC235179577/2019-2020/1-semestre"
            },
            "day": "19/12/2019",
            "end": "14:00",
            "info": "T",
            "period": {
                "end": "19/12/2019 14:00",
                "start": "19/12/2019 12:30"
            },
            "start": "12:30",
            "type": "LESSON",
            "weekday": "Qui"
        },
        {
            "course": {
                "academicTerm": "1\u00ba Semestre 2019/2020",
                "acronym": "PMeca25179577",
                "id": "1408985496305262",
                "name": "Projecto Mec\u00e2nico",
                "url": "https://fenix.tecnico.ulisboa.pt/disciplinas/PMeca25179577/2019-2020/1-semestre"
            },
            "day": "19/12/2019",
            "end": "09:30",
            "info": "T",
            "period": {
                "end": "19/12/2019 09:30",
                "start": "19/12/2019 08:00"
            },
            "start": "08:00",
            "type": "LESSON",
            "weekday": "Qui"
        },
        {
            "course": {
                "academicTerm": "1\u00ba Semestre 2019/2020",
                "acronym": "PMeca25179577",
                "id": "1408985496305262",
                "name": "Projecto Mec\u00e2nico",
                "url": "https://fenix.tecnico.ulisboa.pt/disciplinas/PMeca25179577/2019-2020/1-semestre"
            },
            "day": "17/12/2019",
            "end": "09:30",
            "info": "T",
            "period": {
                "end": "17/12/2019 09:30",
                "start": "17/12/2019 08:00"
            },
            "start": "08:00",
            "type": "LESSON",
            "weekday": "Ter"
        },
        {
            "course": {
                "academicTerm": "1\u00ba Semestre 2019/2020",
                "acronym": "PMeca25179577",
                "id": "1408985496305262",
                "name": "Projecto Mec\u00e2nico",
                "url": "https://fenix.tecnico.ulisboa.pt/disciplinas/PMeca25179577/2019-2020/1-semestre"
            },
            "day": "19/12/2019",
            "end": "11:00",
            "info": "T",
            "period": {
                "end": "19/12/2019 11:00",
                "start": "19/12/2019 09:30"
            },
            "start": "09:30",
            "type": "LESSON",
            "weekday": "Qui"
        },
        {
            "course": {
                "academicTerm": "1\u00ba Semestre 2019/2020",
                "acronym": "QI7",
                "id": "1408985496305250",
                "name": "Qu\u00edmica I",
                "url": "https://fenix.tecnico.ulisboa.pt/disciplinas/QI7/2019-2020/1-semestre"
            },
            "day": "19/12/2019",
            "end": "16:30",
            "info": "PB",
            "period": {
                "end": "19/12/2019 16:30",
                "start": "19/12/2019 15:00"
            },
            "start": "15:00",
            "type": "LESSON",
            "weekday": "Qui"
        },
        {
            "course": {
                "academicTerm": "1\u00ba Semestre 2019/2020",
                "acronym": "CDI2525179577",
                "id": "1408985496305184",
                "name": "C\u00e1lculo Diferencial e Integral I",
                "url": "https://fenix.tecnico.ulisboa.pt/disciplinas/CDI2525179577/2019-2020/1-semestre"
            },
            "day": "17/12/2019",
            "end": "14:00",
            "info": "T",
            "period": {
                "end": "17/12/2019 14:00",
                "start": "17/12/2019 13:00"
            },
            "start": "13:00",
            "type": "LESSON",
            "weekday": "Ter"
        },
        {
            "course": {
                "academicTerm": "1\u00ba Semestre 2019/2020",
                "acronym": "CDI2525179577",
                "id": "1408985496305184",
                "name": "C\u00e1lculo Diferencial e Integral I",
                "url": "https://fenix.tecnico.ulisboa.pt/disciplinas/CDI2525179577/2019-2020/1-semestre"
            },
            "day": "17/12/2019",
            "end": "15:00",
            "info": "T",
            "period": {
                "end": "17/12/2019 15:00",
                "start": "17/12/2019 14:00"
            },
            "start": "14:00",
            "type": "LESSON",
            "weekday": "Ter"
        },
        {
            "course": {
                "academicTerm": "1\u00ba Semestre 2019/2020",
                "acronym": "MC147",
                "id": "1408985496305000",
                "name": "Matem\u00e1tica Computacional",
                "url": "https://fenix.tecnico.ulisboa.pt/disciplinas/MC147/2019-2020/1-semestre"
            },
            "day": "18/12/2019",
            "end": "11:00",
            "info": "T",
            "period": {
                "end": "18/12/2019 11:00",
                "start": "18/12/2019 09:30"
            },
            "start": "09:30",
            "type": "LESSON",
            "weekday": "Qua"
        },
        {
            "course": {
                "academicTerm": "1\u00ba Semestre 2019/2020",
                "acronym": "IASD77",
                "id": "1408985496304976",
                "name": "Intelig\u00eancia Artificial e Sistemas de Decis\u00e3o",
                "url": "https://fenix.tecnico.ulisboa.pt/disciplinas/IASD77/2019-2020/1-semestre"
            },
            "day": "19/12/2019",
            "end": "12:30",
            "info": "PB",
            "period": {
                "end": "19/12/2019 12:30",
                "start": "19/12/2019 11:00"
            },
            "start": "11:00",
            "type": "LESSON",
            "weekday": "Qui"
        },
        {
            "course": {
                "academicTerm": "1\u00ba Semestre 2019/2020",
                "acronym": "CRC7",
                "id": "1408985496304958",
                "name": "Ci\u00eancia das Redes Complexas",
                "url": "https://fenix.tecnico.ulisboa.pt/disciplinas/CRC7/2019-2020/1-semestre"
            },
            "day": "20/12/2019",
            "end": "15:30",
            "info": "T",
            "period": {
                "end": "20/12/2019 15:30",
                "start": "20/12/2019 14:00"
            },
            "start": "14:00",
            "type": "LESSON",
            "weekday": "Sex"
        },
        {
            "course": {
                "academicTerm": "1\u00ba Semestre 2019/2020",
                "acronym": "LN13",
                "id": "1408985496305692",
                "name": "L\u00edngua Natural",
                "url": "https://fenix.tecnico.ulisboa.pt/disciplinas/LN13/2019-2020/1-semestre"
            },
            "day": "18/12/2019",
            "end": "18:00",
            "info": "T",
            "period": {
                "end": "18/12/2019 18:00",
                "start": "18/12/2019 16:30"
            },
            "start": "16:30",
            "type": "LESSON",
            "weekday": "Qua"
        },
        {
            "course": {
                "academicTerm": "1\u00ba Semestre 2019/2020",
                "acronym": "MTer25179577",
                "id": "1408985496305286",
                "name": "Motores T\u00e9rmicos",
                "url": "https://fenix.tecnico.ulisboa.pt/disciplinas/MTer25179577/2019-2020/1-semestre"
            },
            "day": "16/12/2019",
            "end": "18:00",
            "info": "T",
            "period": {
                "end": "16/12/2019 18:00",
                "start": "16/12/2019 16:30"
            },
            "start": "16:30",
            "type": "LESSON",
            "weekday": "Seg"
        },
        {
            "course": {
                "academicTerm": "1\u00ba Semestre 2019/2020",
                "acronym": "Qui1077",
                "id": "1408985496305564",
                "name": "Qu\u00edmica",
                "url": "https://fenix.tecnico.ulisboa.pt/disciplinas/Qui1077/2019-2020/1-semestre"
            },
            "day": "17/12/2019",
            "end": "16:30",
            "info": "T",
            "period": {
                "end": "17/12/2019 16:30",
                "start": "17/12/2019 15:00"
            },
            "start": "15:00",
            "type": "LESSON",
            "weekday": "Ter"
        },
        {
            "day": "16/12/2019",
            "description": "RT 717402",
            "end": "14:30",
            "period": {
                "end": "16/12/2019 14:30",
                "start": "16/12/2019 13:00"
            },
            "start": "13:00",
            "title": "Semin\u00e1rios realizados no \u00e2mbito das Actividades Cient\u00edficas do Departamento.",
            "type": "GENERIC",
            "weekday": "Seg"
        },
        {
            "courses": [
                {
                    "academicTerm": "1\u00ba Semestre 2019/2020",
                    "acronym": "MEstru25179577",
                    "id": "1408985496305295",
                    "name": "Mec\u00e2nica Estrutural",
                    "url": "https://fenix.tecnico.ulisboa.pt/disciplinas/MEstru25179577/2019-2020/1-semestre"
                }
            ],
            "day": "20/12/2019",
            "description": "1\u00baTeste",
            "end": "20:00",
            "period": {
                "end": "20/12/2019 20:00",
                "start": "20/12/2019 18:00"
            },
            "start": "18:00",
            "type": "TEST",
            "weekday": "Sex"
        },
        {
            "courses": [
                {
                    "academicTerm": "1\u00ba Semestre 2019/2020",
                    "acronym": "SSM25179577",
                    "id": "1408985496305422",
                    "name": "Sinais e Sistemas Mecatr\u00f3nicos",
                    "url": "https://fenix.tecnico.ulisboa.pt/disciplinas/SSM25179577/2019-2020/1-semestre"
                }
            ],
            "day": "19/12/2019",
            "description": "2\u00ba.Teste",
            "end": "20:30",
            "period": {
                "end": "19/12/2019 20:30",
                "start": "19/12/2019 19:00"
            },
            "start": "19:00",
            "type": "TEST",
            "weekday": "Qui"
        }
    ],
    "id": "2448131363667",
    "name": "FA1",
    "parentSpace": {
        "id": "2448131361135",
        "name": "0",
        "topLevelSpace": {
            "id": "2448131360897",
            "name": "Alameda",
            "type": "CAMPUS"
        },
        "type": "FLOOR"
    },
    "topLevelSpace": {
        "id": "2448131360897",
        "name": "Alameda",
        "type": "CAMPUS"
    },
    // "type": "ROOM"
};

function secretariatTemplate(secretariat) {
    return `
    <h1>Secretariat: ${secretariat.name}</h1>
    
    <h4>Information:</h4>
    <p> Location:</p> 
    <p>${secretariat.location}</p><br>
    <p> Description: </p>
    <p>${secretariat.description}</p><br>
    <p> Working Hours: </p>
    <p>${secretariat.hours}</p>
    `;
}

function printDate(event) {
    if(date == event.day) return "";
    date = event.day;
    return `
    <li> Day: ${event.day}</li>
    `
}

function printLesson(lesson) {
    return `
    ${printDate(lesson)}
    <p> ${lesson.start} to ${lesson.end}: ${lesson.course.acronym} - ${lesson.info} - ${lesson.course.name}</p>
    `;
}

function printTest(event) {
    return `
    ${printDate(event)}
    <p>${event.start} to ${event.end}</p>
    <ul>
    ${event.courses.map(printCourses).join("")}
    </ul>
    `;
}

function printGeneric(event) {
    return `
    ${printDate(event)}
    <p>${event.start} to ${event.end}: ${event.title}</p>
    `;
}

function printCourses(course) {
    return `
    <li> ${course.acronym} - ${course.name} </li>
    `;
}

function compareDates(a ,b) {
    var dateParts = a.day.split("/");
    var aDate = new Date(+dateParts[2], dateParts[1] - 1, +dateParts[0]); 
    dateParts = b.day.split("/");
    var bDate = new Date(+dateParts[2], dateParts[1] - 1, +dateParts[0]);

    if(aDate - bDate != 0) return aDate - bDate;
    dateParts = a.start.split(":");
    var aHours = dateParts[0];
    var aMinutes = dateParts[1];
    dateParts = b.start.split(":");
    var bHours = dateParts[0];
    var bMinutes = dateParts[1];
    if(aHours != bHours) return aHours - bHours;
    return aMinutes - bMinutes;
}

function lessons(events) {
    return `
    <h3>Lessons</h3>
    <ul>
    ${events.filter(event => event.type == "LESSON").sort(compareDates).map(printLesson).join("")}
    </ul>
    `;
}

function tests(events) {
    return `
    <h3>Tests</h3>
    <ul>
    ${events.filter(event => event.type == "TEST").sort(compareDates).map(printTest).join("<br>")}
    </ul>
    `;
}

function generics(events) {
    return `
    <h3>Generics</h3>
    <ul>
    ${events.filter(event => event.type == "GENERIC").sort(compareDates).map(printGeneric).join("")}
    </ul>
    `;
}

function hasTests(room) {
    for (const event of room.events) {
        if (event.type == "TEST") {
           return true;
        }
    }
    return false;
}

function hasGeneric(room) {
    for (const event of room.events) {
        if (event.type == "GENERIC") {
           return true;
        }
    }
    return false;
}

function hasLessons(room){
    for (const event of room.events) {
        if (event.type == "LESSON") {
           return true;
        }
    }
    return false;
}

function roomTemplate(room) {
    return `
    <h1>Rooms</h1>
    
    <p>ID: ${room.id}</p>
    <p>Name and Location: ${room.name}, ${room.building}, ${room.topLevelSpace.name}</p>
    ${hasLessons(room) ? lessons(room.events) : ""}
    ${hasTests(room) ? tests(room.events) : ""}
    ${hasGeneric(room) ? generics(room.events) : ""}
    `;
} 

var date;

// document.getElementById("divDestiny").innerHTML = `<h1>Unknown Type</h1><br><pre>${JSON.stringify(room, null, 2)}</pre>`;

let scanner = new Instascan.Scanner({ video: document.getElementById('preview'), scanPeriod: 5 });

scanner.addListener('scan', function (content) {
    jQuery.getJSON(content, function(data, status){
        if (data.type == "ROOM")
            document.getElementById("divDestiny").innerHTML = `${roomTemplate(data)}`;
        else if (data.type == "SECRETARIAT")
            document.getElementById("divDestiny").innerHTML = `${secretariatTemplate(data)}`;
        else
            document.getElementById("divDestiny").innerHTML = `<h1>Unknown Type</h1><br><pre>${JSON.stringify(data, null, 2)}</pre>`;
        console.log(data.type)
    });
});

Instascan.Camera.getCameras().then(function (cameras) {
    if (cameras.length > 0) {
        scanner.start(cameras[0]);
    } else {
        console.error('No cameras found.');
    }
}).catch(function (e) {
    console.error(e);
});